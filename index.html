<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Finanzas</title>
<style>
:root{
  --bg:#f4f6f9;
  --card:#ffffff;
  --primary:#2f80ed;
  --primary-dark:#2566c7;
  --text:#333;
}
body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  background:var(--bg);
  color:var(--text);
}
.container{max-width:1100px;margin:auto;padding:10px}
h1{text-align:center}
.card{
  background:var(--card);
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  margin-bottom:12px;
}
form,.filtros{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
  flex:1 1 140px;
}
input::placeholder{color:#aaa}
button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
}
button:hover{background:var(--primary-dark)}
table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
th,td{border-bottom:1px solid #e0e0e0;padding:6px}
th{background:#eef2f7;text-align:left}
.ingreso{color:green}
.gasto{color:red}
.resumen{display:flex;justify-content:space-around;font-weight:bold}
canvas{max-width:100%}
</style>
</head>
<body>
<div class="container">
<h1>Finanzas</h1>

<div class="card">
<form id="form">
  <input type="date" id="fecha" />
  <select id="tipo"><option value="gasto">Gasto</option><option value="ingreso">Ingreso</option></select>
  <select id="cuenta"></select>
  <select id="categoria"></select>
  <input id="concepto" placeholder="Concepto" list="listaConceptos" />
  <datalist id="listaConceptos"></datalist>
  <input type="number" id="monto" step="0.01" placeholder="$ Monto" />
  <button>Agregar</button>
</form>
</div>

<div class="card">
<h3>Importar SMS</h3>
<select id="cuentaSMS"></select>
<textarea id="sms" rows="4" placeholder="Pega aquí los SMS"></textarea>
<button onclick="importarSMS()">Importar</button>
</div>

<div class="card">
<h3>Filtros</h3>
<div class="filtros">
  <input type="month" id="filtroMes" />
  <select id="filtroCuenta"></select>
  <select id="filtroCategoria"></select>
  <button onclick="aplicarFiltros()">Aplicar</button>
  <button onclick="mostrarGrafico()">Gráfico</button>
  <button onclick="exportarCSV()">Exportar CSV</button>
</div>
</div>

<div class="card resumen" id="resumen"></div>

<div class="card"><canvas id="grafico"></canvas></div>

<div class="card">
<table>
<thead><tr><th>Fecha</th><th>Cuenta</th><th>Categoría</th><th>Concepto</th><th>Monto</th></tr></thead>
<tbody id="lista"></tbody>
</table>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const hoy=()=>new Date().toISOString().split('T')[0];
let datos=JSON.parse(localStorage.getItem('finanzas'))||[];
let vista=[...datos];
let cuentas=new Set(['Principal','BPA Eire','BPA Gladis']);
let categorias=new Set(['General']);
let conceptos=new Set();

function llenarSelect(id,set,editable,none){
  const s=document.getElementById(id);s.innerHTML='';
  if(none){const o=document.createElement('option');o.value='';o.textContent='(ninguno)';s.appendChild(o)}
  set.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;s.appendChild(o)});
  if(editable){const o=document.createElement('option');o.value='__new';o.textContent='+ Agregar…';s.appendChild(o)}
  s.onchange=()=>{if(s.value==='__new'){const n=prompt('Nuevo valor');if(n){set.add(n);sync();s.value=n}else s.value=''}}
}

function sync(){
  datos.forEach(d=>{cuentas.add(d.cuenta);categorias.add(d.categoria);conceptos.add(d.concepto)});
  llenarSelect('cuenta',cuentas,true);
  llenarSelect('categoria',categorias,true);
  llenarSelect('cuentaSMS',cuentas,false);
  llenarSelect('filtroCuenta',cuentas,false,true);
  llenarSelect('filtroCategoria',categorias,false,true);
  const dl=document.getElementById('listaConceptos');dl.innerHTML='';conceptos.forEach(c=>{const o=document.createElement('option');o.value=c;dl.appendChild(o)});
}

function guardar(){localStorage.setItem('finanzas',JSON.stringify(datos))}

function render(){
  const l=document.getElementById('lista');l.innerHTML='';
  vista.sort((a,b)=>b.fecha.localeCompare(a.fecha)).forEach(d=>{
    l.innerHTML+=`<tr><td>${d.fecha}</td><td>${d.cuenta}</td><td>${d.categoria}</td><td>${d.concepto}</td><td class="${d.tipo}">$ ${d.monto.toFixed(2)}</td></tr>`
  });
  resumen();
}

function resumen(){
  let ing=0,gas=0;vista.forEach(d=>d.tipo==='ingreso'?ing+=d.monto:gas+=d.monto);
  document.getElementById('resumen').innerHTML=`Ingresos: $${ing.toFixed(2)} | Gastos: $${gas.toFixed(2)} | Saldo: $${(ing-gas).toFixed(2)}`
}

form.onsubmit=e=>{
  e.preventDefault();
  datos.push({fecha:fecha.value,cuenta:cuenta.value,categoria:categoria.value,concepto:concepto.value,monto:+monto.value,tipo:tipo.value});
  vista=[...datos];guardar();sync();render();form.reset();fecha.value=hoy();tipo.value='gasto'
}

function aplicarFiltros(){vista=datos.filter(d=>(!filtroMes.value||d.fecha.startsWith(filtroMes.value))&&(!filtroCuenta.value||d.cuenta===filtroCuenta.value)&&(!filtroCategoria.value||d.categoria===filtroCategoria.value)));render()}

function importarSMS(){sms.value.split('|').forEach(b=>{const p=b.trim().split(';');if(p.length<6)return;const[f,s,op,m,,id]=p;datos.push({fecha:f.split('/').reverse().join('-'),cuenta:cuentaSMS.value,categoria:s||'Banco',concepto:s||'Banco',monto:+m,tipo:op==='CR'?'ingreso':'gasto'})});guardar();sync();vista=[...datos];render();sms.value=''}

let chart;function mostrarGrafico(){if(chart)chart.destroy();const ctx=document.getElementById('grafico');const porMes={};vista.forEach(d=>{const m=d.fecha.slice(0,7);porMes[m]=(porMes[m]||0)+(d.tipo==='ingreso'?d.monto:-d.monto)});chart=new Chart(ctx,{type:'line',data:{labels:Object.keys(porMes),datasets:[{label:'Balance',data:Object.values(porMes)}]}})}

fecha.value=hoy();sync();render();
</script>
</body>
</html>
